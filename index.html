<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0">
	<meta name="referrer" content="no-referrer">
	<title>iPArchive</title>
	<link rel="shortcut icon" href="./favicon.ico">
	<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
	<link rel="stylesheet" href="style.css">
	<script src='script.js'></script>
</head>

<body>
	<header>
		<div class="container">
			<div class="header-content">
				<h1>iPArchive</h1>
				<div class="header-actions">
					<button id="theme-toggle" class="btn btn-icon" aria-label="Toggle dark mode">
						<svg id="theme-icon-light" class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="12" cy="12" r="5"></circle>
							<line x1="12" y1="1" x2="12" y2="3"></line>
							<line x1="12" y1="21" x2="12" y2="23"></line>
							<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
							<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
							<line x1="1" y1="12" x2="3" y2="12"></line>
							<line x1="21" y1="12" x2="23" y2="12"></line>
							<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
							<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
						</svg>
						<svg id="theme-icon-dark" class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
						</svg>
					</button>
					<button class="btn btn-primary" onclick="randomIPA()">Random App</button>
				</div>
			</div>
		</div>
	</header>

	<main class="container">
		<section class="search-section">
			<form class="search-form" onsubmit="event.preventDefault(); searchIPA(); return false;" autocomplete="off">
				<input id="page" hidden>
				<input id="minid" hidden>
				
				<div class="form-row">
					<div class="form-group">
						<label for="search">Search</label>
						<input id="search" class="form-control" placeholder="App name or keyword">
					</div>
					
					<div class="form-group">
						<label for="bundleid">Bundle ID</label>
						<input id="bundleid" class="form-control" placeholder="com.gameloft.">
					</div>
				</div>
				
				<div class="form-row">
					<div class="form-group">
						<label for="minos">Min OS</label>
						<input id="minos" class="form-control" placeholder="6.1.3">
					</div>
					
					<div class="form-group">
						<label for="maxos">Max OS</label>
						<input id="maxos" class="form-control" placeholder="8.3">
					</div>
					
					<div class="form-group">
						<label for="device">Device</label>
						<select id="device" class="form-control">
							<option value="">Any</option>
							<option value="1">iPhone</option>
							<option value="2">iPad</option>
							<option value="3">TV</option>
							<option value="4">Watch</option>
						</select>
					</div>
					
					<div class="form-group checkbox-group">
						<label for="unique" class="checkbox-label">
							<input id="unique" type="checkbox" checked>
							<span>Unique</span>
						</label>
					</div>
				</div>
				
				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Search</button>
				</div>
			</form>
		</section>

		<section class="results-section">
			<div id="content" class="content">JavaScript disabled?</div>
		</section>
	</main>

	<footer class="footer">
		<div class="container">
			<p>iPArchive - iOS App Archive</p>
		</div>
	</footer>

	<div id="templates" hidden>
		<div class="entry full">
			<div class="entry-icon">
				<img src="$IMG" alt="App icon">
				<button class="btn btn-install" onclick="installIPA($IDX)">Install</button>
			</div>
			<div class="info">
				<h4>$TITLE</h4>
				<div><span class="label">Bundle ID:</span> $BUNDLEID</div>
				<div><span class="label">Version:</span> v$VERSION â€“ $SIZE</div>
				<div><span class="label">Device:</span> $PLATFORM</div>
				<div><span class="label">Minimum OS:</span> $MINOS</div>
				<div><span class="label">Link:</span> <a href="$URL" rel="noopener noreferrer nofollow">$URLNAME</a></div>
			</div>
		</div>
		<div class="entry short">
			<div class="entry-icon"><img src="$IMG" alt="App icon"></div>
			<div class="info">
				<h4>$TITLE</h4>
				<div><span class="label">Bundle ID:</span> $BUNDLEID</div>
				<div><span class="label">Device:</span> $PLATFORM</div>
				<div><span class="label">Minimum OS:</span> $MINOS</div>
				<div><a class="show-all" onclick="searchBundle($IDX)">Show all</a></div>
			</div>
		</div>
		<div class="itunes">
			<h4>iTunes Info:</h4>
			<div><span class="label">Genre:</span> $GENRES</div>
			<div><span class="label">Rating:</span> $RATING</div>
			<div><span class="label">Advisory:</span> $ADVISORY</div>
			<br>
			<div><span class="label">Current Version:</span> <b>$VERSION</b> (last update: $DATE)</div>
			<div><span class="label">Price:</span> $PRICE</div>
			<div><span class="label">Link:</span> <a href="$URL" rel="noopener noreferrer nofollow">iTunes</a></div>
			<div>$IMG</div>
			<p class="description">$DESCRIPTION</p>
		</div>
		<a class="screenshot" href="$REF" target="_blank"><img src="$URL" crossorigin="anonymous"
				referrerpolicy="no-referrer" alt="App screenshot"></a>
		<div class="randomAction">
			<span class="label">Actions:</span>
			<button class="btn btn-secondary" onclick="searchBundle($IDX, '&random=$IDX')">Show all versions</button>
			<button class="btn btn-primary" onclick="randomIPA()">Next Random</button>
		</div>
		<div class="no-itunes">
			<p>iTunes search disabled. No plist server configured.</p>
			<a class="configure-link" onclick="installIPA()">Configure now</a>
		</div>
	</div>

	<div id="overlay" class="overlay" style="display: none;">
		<div id="installMsg" class="install-modal">
			<h3>Install on device</h3>
			<p>
				Unfortunately, this function is not possible with static HTML+JS.
				You must provide a plist generator URL.
				See <a href="Readme.md" target="_blank">Readme</a> file for further instructions on how to set up such a
				service.
			</p>
			<form onsubmit="event.preventDefault(); setPlistGen(); return false;" autocomplete="off">
				<div class="form-group">
					<label for="plistServer">Generator URL:</label>
					<input id="plistServer" class="form-control" placeholder="http://192.168.0.1/">
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Save</button>
					<button type="button" class="btn btn-secondary" onclick="hideOverlay()">Cancel</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// Make sure overlay is hidden on page load
		document.addEventListener('DOMContentLoaded', function() {
			initTheme();
			document.getElementById('overlay').style.display = 'none';
			loadDB();
		});
		
		// Theme toggle functionality
		function initTheme() {
			const themeToggle = document.getElementById('theme-toggle');
			const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
			
			// Check for saved theme preference or use system preference
			const savedTheme = localStorage.getItem('theme');
			if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
				document.body.classList.add('dark-theme');
			}
			
			updateThemeIcon();
			
			// Add event listener to toggle button
			themeToggle.addEventListener('click', function() {
				document.body.classList.toggle('dark-theme');
				updateThemeIcon();
				
				// Save preference to localStorage
				const isDark = document.body.classList.contains('dark-theme');
				localStorage.setItem('theme', isDark ? 'dark' : 'light');
			});
		}
		
		function updateThemeIcon() {
			const isDark = document.body.classList.contains('dark-theme');
			document.getElementById('theme-icon-light').style.display = isDark ? 'none' : 'block';
			document.getElementById('theme-icon-dark').style.display = isDark ? 'block' : 'none';
		}
		
		// Function to show overlay
		function showOverlay() {
			document.getElementById('overlay').style.display = 'flex';
		}
		
		// Function to hide overlay
		function hideOverlay() {
			document.getElementById('overlay').style.display = 'none';
		}
		
		// Modified installIPA function to show overlay
		function installIPA(idx) {
			if (!plistServerUrl) {
				showOverlay();
				return;
			}
			// Rest of the original installIPA function
			const thisServerUrl = location.href.replace(location.hash, '');
			const entry = entryToDict(DB[idx]);
			const json = JSON.stringify({
				u: validUrl(entry.ipa_url),
				n: entry.title,
				b: entry.bundleId,
				v: entry.version.split(' ')[0],
				i: urlWithSlash(thisServerUrl) + entry.img_url,
			}, null, 0)
			var b64 = '';
			try {
				b64 = btoa(json);
			} catch (error) {
				b64 = utoa(json);
			}
			while (b64.slice(-1) === '=') {
				b64 = b64.slice(0, -1);
			}
			const plistUrl = plistServerUrl + '%3Fd%3D' + b64; // url encoded "?d="
			window.open('itms-services://?action=download-manifest&url=' + plistUrl);
		}
		
	</script>
</body>

</html>
